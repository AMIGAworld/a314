.PHONY: bin_dir all

ifndef VERBOSE
.SILENT:
endif

A314_SERVICES        = a314d/a314d.py \
                       a314fs/a314fs.py \
                       picmd/picmd.py \
                       piaudio/piaudio.py \
                       remote-mouse/remote-mouse.py \
                       hid/hid.py \
                       ethernet/ethernet.py \
                       disk/disk.py \
		       remotewb/remotewb.py \
		       videoplayer/videoplayer.py

A314_SERVICE_CONFIGS = a314fs/a314fs.conf \
                       picmd/picmd.conf \
                       disk/disk.conf

A314_PI_BINARIES     = ${BIN}/a314d


CPP=g++
CC=gcc
BIN=bin_pi

# Figure out the primary group and home directory of the user who used sudo
SUDO_GROUP=$(shell getent group ${SUDO_GID} | cut -d: -f1)
SUDO_HOME=$(shell awk -F':' -v U=${SUDO_USER} '$$1==U {print $$6}' /etc/passwd)

# Replace some magic strings in files while installing to work with any username
define modinstall
	sed -e s%##USER##%${SUDO_USER}%g -e s%##GROUP##%${SUDO_GROUP}%g -e s%##HOME##%${SUDO_HOME}%g $(1) >$(2)/$(shell basename $(1))
endef

all: bin_dir ${BIN}/a314d ${BIN}/spi-a314.dtbo

bin_dir:
	mkdir -p ${BIN}

${BIN}/a314d: a314d/a314d.cc
	@echo "Building $@"
	${CPP} -DMODEL_TR=1 a314d/a314d.cc -O3 -o ${BIN}/a314d

${BIN}/spi-a314.dtbo: a314d/spi-a314-overlay.dts
	dtc -I dts -O dtb -o ${BIN}/spi-a314.dtbo a314d/spi-a314-overlay.dts

install:
ifneq ($(shell id -u), 0)
	@echo "Please run the install using sudo"
	@exit 1
endif
	@echo "Installing A314 files..."
	install -d ${SUDO_HOME}/a314shared -o ${SUDO_USER} -g ${SUDO_GROUP}
	install -d /opt/a314
	install -d /etc/opt/a314
	install ${A314_SERVICES} /opt/a314
	install ${A314_PI_BINARIES} /opt/a314
	install a314d/a314d.conf /etc/opt/a314
	$(foreach filename, $(A314_SERVICE_CONFIGS), $(call modinstall, $(filename), /etc/opt/a314/);)
	cd bpls2gif ; python3 setup.py install
	pip3 install websockets
	pip3 install pyudev
	pip3 install python-pytun
	$(call modinstall, ethernet/pi-config/tap0, /etc/network/interfaces.d)
	$(call modinstall, a314d/a314d-td.service, /lib/systemd/system/a314d.service)
	install ${BIN}/spi-a314.dtbo /boot/overlays
	@echo "Installation completed!"
